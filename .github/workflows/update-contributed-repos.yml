name: Update Contributed Repositories

on:
  schedule:
    # Запускается каждый день в 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # Позволяет запускать вручную
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-contributed-repos.yml'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get contributed repositories
        id: get-repos
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const username = 'johnnyshut';
            const repos = new Map();
            
            try {
              // Используем GraphQL API для получения Pull Requests и Issues
              // Это аналогично секции "Contributed to" на GitHub профиле
              console.log('Поиск через Pull Requests и Issues (как в секции Contributed to)...');
              
              // GraphQL запрос для получения PR где пользователь автор
              const prQuery = `
                query($username: String!, $cursor: String) {
                  user(login: $username) {
                    pullRequests(first: 100, after: $cursor, states: [MERGED, OPEN, CLOSED]) {
                      pageInfo {
                        hasNextPage
                        endCursor
                      }
                      nodes {
                        repository {
                          nameWithOwner
                          description
                          stargazerCount
                          primaryLanguage {
                            name
                          }
                          url
                          updatedAt
                          owner {
                            login
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              // Получаем Pull Requests
              let prCursor = null;
              let hasMorePRs = true;
              let prPage = 0;
              const maxPRPages = 5;
              
              while (hasMorePRs && prPage < maxPRPages) {
                try {
                  const prResponse = await github.graphql(prQuery, {
                    username: username,
                    cursor: prCursor
                  });
                  
                  if (prResponse.user && prResponse.user.pullRequests) {
                    const prs = prResponse.user.pullRequests.nodes;
                    const pageInfo = prResponse.user.pullRequests.pageInfo;
                    
                    console.log(`Обработка PR страницы ${prPage + 1}, найдено: ${prs.length}`);
                    
                    for (const pr of prs) {
                      if (pr.repository && pr.repository.nameWithOwner) {
                        const repoName = pr.repository.nameWithOwner;
                        const owner = pr.repository.owner.login;
                        
                        // Исключаем собственные репозитории
                        if (owner !== username && !repos.has(repoName)) {
                          repos.set(repoName, {
                            name: repoName,
                            description: pr.repository.description || 'Без описания',
                            stars: pr.repository.stargazerCount || 0,
                            language: pr.repository.primaryLanguage?.name || 'N/A',
                            url: pr.repository.url,
                            updated: pr.repository.updatedAt
                          });
                          console.log(`Добавлен репозиторий через PR: ${repoName}`);
                        }
                      }
                    }
                    
                    hasMorePRs = pageInfo.hasNextPage;
                    prCursor = pageInfo.endCursor;
                    prPage++;
                  } else {
                    hasMorePRs = false;
                  }
                } catch (error) {
                  console.log(`Ошибка при получении PR: ${error.message}`);
                  hasMorePRs = false;
                }
              }
              
              // GraphQL запрос для получения Issues где пользователь автор
              const issueQuery = `
                query($username: String!, $cursor: String) {
                  user(login: $username) {
                    issues(first: 100, after: $cursor, states: [OPEN, CLOSED]) {
                      pageInfo {
                        hasNextPage
                        endCursor
                      }
                      nodes {
                        repository {
                          nameWithOwner
                          description
                          stargazerCount
                          primaryLanguage {
                            name
                          }
                          url
                          updatedAt
                          owner {
                            login
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              // Получаем Issues
              let issueCursor = null;
              let hasMoreIssues = true;
              let issuePage = 0;
              const maxIssuePages = 3;
              
              while (hasMoreIssues && issuePage < maxIssuePages) {
                try {
                  const issueResponse = await github.graphql(issueQuery, {
                    username: username,
                    cursor: issueCursor
                  });
                  
                  if (issueResponse.user && issueResponse.user.issues) {
                    const issues = issueResponse.user.issues.nodes;
                    const pageInfo = issueResponse.user.issues.pageInfo;
                    
                    console.log(`Обработка Issues страницы ${issuePage + 1}, найдено: ${issues.length}`);
                    
                    for (const issue of issues) {
                      if (issue.repository && issue.repository.nameWithOwner) {
                        const repoName = issue.repository.nameWithOwner;
                        const owner = issue.repository.owner.login;
                        
                        // Исключаем собственные репозитории
                        if (owner !== username && !repos.has(repoName)) {
                          repos.set(repoName, {
                            name: repoName,
                            description: issue.repository.description || 'Без описания',
                            stars: issue.repository.stargazerCount || 0,
                            language: issue.repository.primaryLanguage?.name || 'N/A',
                            url: issue.repository.url,
                            updated: issue.repository.updatedAt
                          });
                          console.log(`Добавлен репозиторий через Issue: ${repoName}`);
                        }
                      }
                    }
                    
                    hasMoreIssues = pageInfo.hasNextPage;
                    issueCursor = pageInfo.endCursor;
                    issuePage++;
                  } else {
                    hasMoreIssues = false;
                  }
                } catch (error) {
                  console.log(`Ошибка при получении Issues: ${error.message}`);
                  hasMoreIssues = false;
                }
              }
              
            } catch (error) {
              console.log(`Общая ошибка при получении репозиториев: ${error.message}`);
            }
            
            console.log(`Всего найдено репозиториев: ${repos.size}`);
            
            // Сортируем по дате обновления и берем топ 15
            const sortedRepos = Array.from(repos.values())
              .sort((a, b) => new Date(b.updated) - new Date(a.updated))
              .slice(0, 15);
            
            // Формируем markdown таблицу
            let markdown = '';
            if (sortedRepos.length > 0) {
              markdown = '| Репозиторий | Описание | ⭐ | Язык |\n';
              markdown += '|-------------|----------|----|------|\n';
              
              for (const repo of sortedRepos) {
                const desc = repo.description.length > 50 
                  ? repo.description.substring(0, 50) + '...' 
                  : repo.description;
                // Экранируем символы для markdown
                const safeDesc = desc.replace(/\|/g, '\\|').replace(/\n/g, ' ');
                markdown += `| [${repo.name}](${repo.url}) | ${safeDesc} | ${repo.stars} | ${repo.language} |\n`;
              }
            } else {
              markdown = '_Пока нет проектов для отображения_';
            }
            
            core.setOutput('repos_markdown', markdown);
            core.setOutput('repos_count', sortedRepos.length.toString());

      - name: Update README
        uses: actions/github-script@v7
        env:
          REPOS_MARKDOWN: ${{ steps.get-repos.outputs.repos_markdown }}
          REPOS_COUNT: ${{ steps.get-repos.outputs.repos_count }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const readmePath = path.join(process.cwd(), 'profile', 'README.md');
            let readme = fs.readFileSync(readmePath, 'utf8');
            
            // Находим секцию с проектами (между маркерами)
            const startMarker = '<!-- CONTRIBUTED_REPOS_START -->';
            const endMarker = '<!-- CONTRIBUTED_REPOS_END -->';
            
            const startIndex = readme.indexOf(startMarker);
            const endIndex = readme.indexOf(endMarker);
            
            if (startIndex !== -1 && endIndex !== -1) {
              const before = readme.substring(0, startIndex + startMarker.length);
              const after = readme.substring(endIndex);
              
              const reposMarkdown = process.env.REPOS_MARKDOWN || '';
              const reposCount = process.env.REPOS_COUNT || '0';
              
              const newSection = `\n\n<h3 align="left">Проекты где я контрибьютор</h3>\n\n[![Contributed Repos](https://img.shields.io/badge/контрибьютор%20в-${reposCount}%20проектах-blue)](https://github.com/search?q=author%3Ajohnnyshut+-user%3Ajohnnyshut&type=Repositories)\n\n${reposMarkdown}\n\n`;
              
              readme = before + newSection + after;
              
              fs.writeFileSync(readmePath, readme);
            }

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add profile/README.md
          git diff --staged --quiet || git commit -m "chore: обновить список репозиториев где я контрибьютор" || exit 0
          git push

