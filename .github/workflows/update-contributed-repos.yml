name: Update Contributed Repositories

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-contributed-repos.yml'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get contributed repositories
        id: get-repos
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const username = 'johnnyshut';
            const repos = new Map();
            
            // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫ –∫–æ–º–º–∏—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try {
              // –ü–æ–ª—É—á–∞–µ–º —Å–æ–±—ã—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (PushEvent, PullRequestEvent –∏ —Ç.–¥.)
              let page = 1;
              let hasMore = true;
              const maxPages = 3; // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
              
              while (hasMore && page <= maxPages) {
                const events = await github.rest.activity.listPublicEventsForUser({
                  username: username,
                  per_page: 100,
                  page: page
                });
                
                if (events.data.length === 0) {
                  hasMore = false;
                  break;
                }
                
                for (const event of events.data) {
                  // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ PushEvent –∏ PullRequestEvent
                  if ((event.type === 'PushEvent' || event.type === 'PullRequestEvent') 
                      && event.repo 
                      && event.repo.full_name 
                      && !event.repo.full_name.startsWith(username + '/')) {
                    const repoName = event.repo.full_name;
                    
                    if (!repos.has(repoName)) {
                      try {
                        const [owner, repo] = repoName.split('/');
                        const repoData = await github.rest.repos.get({
                          owner: owner,
                          repo: repo
                        });
                        
                        repos.set(repoName, {
                          name: repoName,
                          description: repoData.data.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è',
                          stars: repoData.data.stargazers_count,
                          language: repoData.data.language || 'N/A',
                          url: repoData.data.html_url,
                          updated: repoData.data.updated_at
                        });
                      } catch (error) {
                        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
                        console.log(`–ü—Ä–æ–ø—É—â–µ–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π ${repoName}: ${error.message}`);
                      }
                    }
                  }
                }
                
                page++;
                if (events.data.length < 100) hasMore = false;
              }
            } catch (error) {
              console.log(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤: ${error.message}`);
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –±–µ—Ä–µ–º —Ç–æ–ø 15
            const sortedRepos = Array.from(repos.values())
              .sort((a, b) => new Date(b.updated) - new Date(a.updated))
              .slice(0, 15);
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º markdown —Ç–∞–±–ª–∏—Ü—É
            let markdown = '';
            if (sortedRepos.length > 0) {
              markdown = '| –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π | –û–ø–∏—Å–∞–Ω–∏–µ | ‚≠ê | –Ø–∑—ã–∫ |\n';
              markdown += '|-------------|----------|----|------|\n';
              
              for (const repo of sortedRepos) {
                const desc = repo.description.length > 50 
                  ? repo.description.substring(0, 50) + '...' 
                  : repo.description;
                // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Å–∏–º–≤–æ–ª—ã –¥–ª—è markdown
                const safeDesc = desc.replace(/\|/g, '\\|').replace(/\n/g, ' ');
                markdown += `| [${repo.name}](${repo.url}) | ${safeDesc} | ${repo.stars} | ${repo.language} |\n`;
              }
            } else {
              markdown = '_–ü–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è_';
            }
            
            core.setOutput('repos_markdown', markdown);
            core.setOutput('repos_count', sortedRepos.length.toString());

      - name: Update README
        uses: actions/github-script@v7
        env:
          REPOS_MARKDOWN: ${{ steps.get-repos.outputs.repos_markdown }}
          REPOS_COUNT: ${{ steps.get-repos.outputs.repos_count }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const readmePath = path.join(process.cwd(), 'profile', 'README.md');
            let readme = fs.readFileSync(readmePath, 'utf8');
            
            // –ù–∞—Ö–æ–¥–∏–º —Å–µ–∫—Ü–∏—é —Å –ø—Ä–æ–µ–∫—Ç–∞–º–∏ (–º–µ–∂–¥—É –º–∞—Ä–∫–µ—Ä–∞–º–∏)
            const startMarker = '<!-- CONTRIBUTED_REPOS_START -->';
            const endMarker = '<!-- CONTRIBUTED_REPOS_END -->';
            
            const startIndex = readme.indexOf(startMarker);
            const endIndex = readme.indexOf(endMarker);
            
            if (startIndex !== -1 && endIndex !== -1) {
              const before = readme.substring(0, startIndex + startMarker.length);
              const after = readme.substring(endIndex);
              
              const reposMarkdown = process.env.REPOS_MARKDOWN || '';
              const reposCount = process.env.REPOS_COUNT || '0';
              
              const newSection = `\n\n<h3 align="left">üì¶ –ü—Ä–æ–µ–∫—Ç—ã –≥–¥–µ —è –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä</h3>\n\n[![Contributed Repos](https://img.shields.io/badge/–∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä%20–≤-${reposCount}%20–ø—Ä–æ–µ–∫—Ç–∞—Ö-blue)](https://github.com/search?q=author%3Ajohnnyshut+-user%3Ajohnnyshut&type=Repositories)\n\n${reposMarkdown}\n\n`;
              
              readme = before + newSection + after;
              
              fs.writeFileSync(readmePath, readme);
            }

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add profile/README.md
          git diff --staged --quiet || git commit -m "chore: –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –≥–¥–µ —è –∫–æ–Ω—Ç—Ä–∏–±—å—é—Ç–æ—Ä" || exit 0
          git push

