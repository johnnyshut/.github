name: Update Contributed Repositories

on:
  schedule:
    - cron: '0 0 1 * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - '.github/workflows/update-contributed-repos.yml'

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get contributed repositories
        id: get-repos
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const username = 'johnnyshut';
            const repos = new Map();
            
            try {
              const prQuery = `
                query($username: String!, $cursor: String) {
                  user(login: $username) {
                    pullRequests(first: 100, after: $cursor, states: [MERGED, OPEN, CLOSED]) {
                      pageInfo {
                        hasNextPage
                        endCursor
                      }
                      nodes {
                        repository {
                          nameWithOwner
                          description
                          stargazerCount
                          primaryLanguage {
                            name
                          }
                          url
                          updatedAt
                          owner {
                            login
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              let prCursor = null;
              let hasMorePRs = true;
              let prPage = 0;
              const maxPRPages = 5;
              
              while (hasMorePRs && prPage < maxPRPages) {
                try {
                  const prResponse = await github.graphql(prQuery, {
                    username: username,
                    cursor: prCursor
                  });
                  
                  if (prResponse.user && prResponse.user.pullRequests) {
                    const prs = prResponse.user.pullRequests.nodes;
                    const pageInfo = prResponse.user.pullRequests.pageInfo;
                    
                    for (const pr of prs) {
                      if (pr.repository && pr.repository.nameWithOwner) {
                        const repoName = pr.repository.nameWithOwner;
                        const owner = pr.repository.owner.login;
                        
                        if (owner !== username) {
                          if (!repos.has(repoName)) {
                            repos.set(repoName, {
                              name: repoName,
                              description: pr.repository.description || 'Без описания',
                              stars: pr.repository.stargazerCount || 0,
                              language: pr.repository.primaryLanguage?.name || 'N/A',
                              url: pr.repository.url,
                              updated: pr.repository.updatedAt,
                              prCount: 0,
                              issueCount: 0
                            });
                          }
                          const repo = repos.get(repoName);
                          repo.prCount = (repo.prCount || 0) + 1;
                          repos.set(repoName, repo);
                        }
                      }
                    }
                    
                    hasMorePRs = pageInfo.hasNextPage;
                    prCursor = pageInfo.endCursor;
                    prPage++;
                  } else {
                    hasMorePRs = false;
                  }
                } catch (error) {
                  hasMorePRs = false;
                }
              }
              
              const issueQuery = `
                query($username: String!, $cursor: String) {
                  user(login: $username) {
                    issues(first: 100, after: $cursor, states: [OPEN, CLOSED]) {
                      pageInfo {
                        hasNextPage
                        endCursor
                      }
                      nodes {
                        repository {
                          nameWithOwner
                          description
                          stargazerCount
                          primaryLanguage {
                            name
                          }
                          url
                          updatedAt
                          owner {
                            login
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              let issueCursor = null;
              let hasMoreIssues = true;
              let issuePage = 0;
              const maxIssuePages = 3;
              
              while (hasMoreIssues && issuePage < maxIssuePages) {
                try {
                  const issueResponse = await github.graphql(issueQuery, {
                    username: username,
                    cursor: issueCursor
                  });
                  
                  if (issueResponse.user && issueResponse.user.issues) {
                    const issues = issueResponse.user.issues.nodes;
                    const pageInfo = issueResponse.user.issues.pageInfo;
                    
                    for (const issue of issues) {
                      if (issue.repository && issue.repository.nameWithOwner) {
                        const repoName = issue.repository.nameWithOwner;
                        const owner = issue.repository.owner.login;
                        
                        if (owner !== username) {
                          if (!repos.has(repoName)) {
                            repos.set(repoName, {
                              name: repoName,
                              description: issue.repository.description || 'Без описания',
                              stars: issue.repository.stargazerCount || 0,
                              language: issue.repository.primaryLanguage?.name || 'N/A',
                              url: issue.repository.url,
                              updated: issue.repository.updatedAt,
                              prCount: 0,
                              issueCount: 0
                            });
                          }
                          const repo = repos.get(repoName);
                          repo.issueCount = (repo.issueCount || 0) + 1;
                          repos.set(repoName, repo);
                        }
                      }
                    }
                    
                    hasMoreIssues = pageInfo.hasNextPage;
                    issueCursor = pageInfo.endCursor;
                    issuePage++;
                  } else {
                    hasMoreIssues = false;
                  }
                } catch (error) {
                  hasMoreIssues = false;
                }
              }
              
            } catch (error) {
            }
            
            const sortedRepos = Array.from(repos.values())
              .map(repo => ({
                ...repo,
                totalContributions: (repo.prCount || 0) + (repo.issueCount || 0)
              }))
              .sort((a, b) => {
                if (b.totalContributions !== a.totalContributions) {
                  return b.totalContributions - a.totalContributions;
                }
                return a.name.localeCompare(b.name);
              })
              .slice(0, 20);
            
            let markdown = '';
            if (sortedRepos.length > 0) {
              markdown = '| Репозиторий | Описание | ⭐ | Язык |\n';
              markdown += '|-------------|----------|----|------|\n';
              
              for (const repo of sortedRepos) {
                const desc = repo.description.length > 50 
                  ? repo.description.substring(0, 50) + '...' 
                  : repo.description;
                const safeDesc = desc.replace(/\|/g, '\\|').replace(/\n/g, ' ');
                markdown += `| [${repo.name}](${repo.url}) | ${safeDesc} | ${repo.stars} | ${repo.language} |\n`;
              }
            } else {
              markdown = '_Пока нет проектов для отображения_';
            }
            
            core.setOutput('repos_markdown', markdown);
            core.setOutput('repos_count', sortedRepos.length.toString());

      - name: Update README
        uses: actions/github-script@v7
        env:
          REPOS_MARKDOWN: ${{ steps.get-repos.outputs.repos_markdown }}
          REPOS_COUNT: ${{ steps.get-repos.outputs.repos_count }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            const readmePath = path.join(process.cwd(), 'profile', 'README.md');
            let readme = fs.readFileSync(readmePath, 'utf8');
            
            const startMarker = '<!-- CONTRIBUTED_REPOS_START -->';
            const endMarker = '<!-- CONTRIBUTED_REPOS_END -->';
            
            const startIndex = readme.indexOf(startMarker);
            const endIndex = readme.indexOf(endMarker);
            
            if (startIndex !== -1 && endIndex !== -1) {
              const before = readme.substring(0, startIndex + startMarker.length);
              const after = readme.substring(endIndex);
              
              const reposMarkdown = process.env.REPOS_MARKDOWN || '';
              const reposCount = process.env.REPOS_COUNT || '0';
              
              const newSection = `\n\n[![Contributed Repos](https://img.shields.io/badge/контрибьютор%20в-${reposCount}%20проектах-blue)](https://github.com/search?q=author%3Ajohnnyshut+-user%3Ajohnnyshut&type=pullrequests)\n\n${reposMarkdown}\n\n`;
              
              readme = before + newSection + after;
              
              fs.writeFileSync(readmePath, readme);
            }

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add profile/README.md
          git diff --staged --quiet || git commit -m "chore: обновление списка проектов в README" || exit 0
          git push

